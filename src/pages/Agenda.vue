<!-- eslint-disable vue/valid-v-slot -->

<template>
  <div class="subcontent">
    <!-- <button @click="onNext">NEXT</button> -->
    <div class="q-ma-sm q-gutter-sm row justify-center">
      <q-select
        filled
        v-model="selected"
        :options="options"
        label="Modo de
      visualização"
        emit-value
        map-options
        style="min-width: 180px"
        transition-show="scale"
        transition-hide="scale"
      />
    </div>

    <div class="row justify-center">
      <div style="display: flex; max-width: 800px; width: 100%; height: 400px">
        <q-calendar-day
          ref="calendar"
          v-model="selectedDate"
          use-navigation
          no-active-date
          bordered
          :view="selected"
          :max-days="selected === 'day' ? 1 : 0"
          :weekdays="[1, 2, 3, 4, 5, 6, 7, 0]"
          :hour24-format="hour24"
          :interval-start="16"
          :interval-minutes="30"
          :interval-count="50"
          :interval-height="40"
          :disabled-after="disabledAfter"
          :disabled-before="disabledBefore"
          short-weekday-label
          animated
          locale="pt-BR"
          @click-time="onClickTime"
          v-touch-swipe.mouse.left.right="handleSwipe"
          transition-prev="slide-right"
          transition-next="slide-left"
        >
          <template #head-day-event="{ scope: { timestamp } }">
            <div
              style="
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                padding: 2px;
              "
            >
              <template
                v-for="event in eventsMap[timestamp.date]"
                :key="event.id"
              >
                <q-badge
                  v-if="!event.time"
                  :class="badgeClasses(event, 'header')"
                  :style="badgeStyles(event, 'header')"
                  style="
                    width: 100%;
                    cursor: pointer;
                    height: 12px;
                    font-size: 10px;
                    margin: 1px;
                  "
                >
                  <div class="title q-calendar__ellipsis">
                    {{ event.title }}
                    <q-tooltip>{{ event.details }}</q-tooltip>
                  </div>
                </q-badge>
                <q-badge
                  v-else
                  :class="badgeClasses(event, 'header')"
                  :style="badgeStyles(event, 'header')"
                  style="
                    margin: 1px;
                    width: 10px;
                    max-width: 10px;
                    height: 10px;
                    max-height: 10px;
                    cursor: pointer;
                  "
                  @click="scrollToEvent(event)"
                >
                  <q-tooltip>{{
                    event.time + " - " + event.details
                  }}</q-tooltip>
                </q-badge>
              </template>
            </div>
          </template>

          <template
            #day-body="{
              scope: { timestamp, timeStartPos, timeDurationHeight },
            }"
          >
            <template
              v-for="event in getEvents(timestamp.date)"
              :key="event.id"
            >
              <div
                v-if="event.time !== undefined"
                class="my-event"
                :class="badgeClasses(event, 'body')"
                :style="
                  badgeStyles(event, 'body', timeStartPos, timeDurationHeight)
                "
              >
                <span class="title q-calendar__ellipsis">
                  {{ event.time }}

                  <q-tooltip>{{ event.details }}</q-tooltip>
                </span>
              </div>
            </template>
          </template>
        </q-calendar-day>
      </div>
    </div>
  </div>
</template>
<style src="@quasar/quasar-ui-qcalendar/dist/QCalendarDay.min.css"></style>
<script>
import { defineComponent, ref, computed, onMounted } from "vue";
import "@quasar/quasar-ui-qcalendar/dist/QCalendarTransitions.css";
import {
  QCalendarDay,
  addToDate,
  parseTimestamp,
  isBetweenDates,
  parsed,
  parseTime,
} from "@quasar/quasar-ui-qcalendar/src/index.js";
import "@quasar/quasar-ui-qcalendar/src/QCalendarVariables.sass";
import "@quasar/quasar-ui-qcalendar/src/QCalendarTransitions.sass";
import "@quasar/quasar-ui-qcalendar/src/QCalendar.sass";

export default defineComponent({
  name: "CalendarAll",
  components: {
    QCalendarDay,
  },
  setup() {
    const selected = ref("day");

    const options = ref([
      { label: "Dia", value: "day" },
      { label: "Semana", value: "week" },
    ]);
    const view = ref("day");
    const hour24 = true;
    const dragging = false;
    let ignoreNextSwipe = false;
    const selectedCalendar = ref("agenda"),
      calendar = ref(null),
      selectedDate = ref("2023-10-04"), // seleted day
      events = ref([
        {
          id: 1,
          title: "Abertura – Som mecânico",
          details: "Time to pitch my idea to the company",
          date: "2023-10-04",
          time: "09:00",
          duration: 60,
          bgcolor: "red",
          icon: "fas fa-handshake",
        },
        {
          id: 2,
          title: "Banda Os Fritz",
          details: "Company is paying!",
          date: "2023-10-04",
          time: "12:00",
          duration: 60,
          bgcolor: "teal",
          icon: "fas fa-hamburger",
        },
        {
          id: 3,
          title: "Abertura – Som mecânico",
          details: "Teaching Javascript 101",
          date: "2023-10-05",
          time: "13:00",
          duration: 60,
          bgcolor: "blue",
          icon: "fas fa-chalkboard-teacher",
        },
        {
          id: 4,
          title: "Abertura – Som mecânico",
          details: "Meet GF for dinner at Swanky Restaurant",
          date: "2023-10-07",
          time: "19:00",
          duration: 60,
          bgcolor: "teal-2",
          icon: "fas fa-utensils",
        },
      ]);

    // doc about computed vue 3
    // https://vuejs.org/guide/essentials/computed.html#basic-example
    const disabledAfter = computed(() => {
      let ts = parseTimestamp("2023-10-04");
      ts = addToDate(ts, { day: 19 });
      return ts.date;
    });

    const disabledBefore = computed(() => {
      let ts = parseTimestamp("2023-10-04");
      ts = addToDate(ts, { day: -1 });
      return ts.date;
    });

    // convert the events into a map of lists keyed by date
    const eventsMap = computed(() => {
      const map = {};
      // this.events.forEach(event => (map[ event.date ] = map[ event.date ] || []).push(event))
      events.value.map((event) => {
        if (!map[event.date]) {
          map[event.date] = [];
        }
        map[event.date].push(event);
        if (event.days) {
          let timestamp = parseTimestamp(event.date);
          let days = event.days;
          do {
            timestamp = addToDate(timestamp, { day: 1 });
            if (!map[timestamp.date]) {
              map[timestamp.date] = [];
            }
            map[timestamp.date].push(event);
          } while (--days > 0);
        }
      });
      return map;
    });

    const badgeClasses = (event, type) => {
      const isHeader = type.value === "header";
      return {
        [`text-white bg-${event.bgcolor}`]: true,
        "full-width": !isHeader && (!event.side || event.side === "full"),
        "left-side": !isHeader && event.side === "left",
        "right-side": !isHeader && event.side === "right",
        "rounded-border": true,
      };
    };

    const badgeStyles = (
      event,
      type,
      timeStartPos = undefined,
      timeDurationHeight = undefined
    ) => {
      const s = {};
      if (timeStartPos && timeDurationHeight) {
        s.top = timeStartPos(event.time) + "px";
        s.height = timeDurationHeight(event.duration) + "px";
      }
      s["align-items"] = "flex-start";
      return s;
    };

    const getEvents = (dt) => {
      const events = eventsMap.value[dt] || [];

      if (events.length === 1) {
        events[0].side = "full";
      } else if (events.length === 2) {
        // this example does no more than 2 events per day
        // check if the two events overlap and if so, select
        // left or right side alignment to prevent overlap
        const startTime = addToDate(parsed(events[0].date), {
          minute: parseTime(events[0].time),
        });

        const endTime = addToDate(startTime, { minute: events[0].duration });
        const startTime2 = addToDate(parsed(events[1].date), {
          minute: parseTime(events[1].time),
        });
        const endTime2 = addToDate(startTime2, { minute: events[1].duration });
        if (
          isBetweenDates(startTime2, startTime, endTime, true) ||
          isBetweenDates(endTime2, startTime, endTime, true)
        ) {
          events[0].side = "left";
          events[1].side = "right";
        } else {
          events[0].side = "full";
          events[1].side = "full";
        }
      }
      return events;
    };

    const scrollToEvent = (event) => {
      calendar.value.scrollToTime(event.time, 350);
    };

    const onClickTime = () => {
      console.log("onClickTime");
    };

    function onPrev() {
      calendar.value.prev();
    }
    function onNext() {
      calendar.value.next();
    }

    // Doc about swipe
    // https://quasar.dev/vue-directives/touch-swipe/
    const handleSwipe = ({ evt, ...info }) => {
      if (dragging === false) {
        if (info.duration >= 30 && ignoreNextSwipe === false) {
          if (info.direction === "right") {
            onPrev();
          } else if (info.direction === "left") {
            onNext();
          }
        } else {
          ignoreNextSwipe = false;
        }
      }
      // stopAndPrevent(evt)
      evt.cancelable !== false && evt.preventDefault();
      evt.stopPropagation();
    };

    function onToday() {
      calendar.value.moveToToday();
    }

    // onBeforeMount(() => {
    //   // adjust all the dates for the current month so examples don't expire
    // });

    return {
      selected,
      options,
      selectedDate,
      selectedCalendar,
      view,
      calendar,
      hour24,
      events,
      dragging,
      ignoreNextSwipe,
      disabledAfter,
      disabledBefore,
      eventsMap,
      handleSwipe,
      onClickTime,
      onToday,
      onPrev,
      onNext,
      badgeClasses,
      badgeStyles,
      getEvents,
      scrollToEvent,
    };
  },
});
</script>
<style scoped>
.my-event {
  position: absolute;
  font-size: 12px;
  justify-content: center;
  margin: 0 1px;
  text-overflow: ellipsis;
  overflow: hidden;
  cursor: pointer;
}
.title {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}
.text-white {
  color: white;
}

.bg-blue {
  background: blue;
}

.bg-green {
  background: green;
}

.bg-orange {
  background: orange;
}

.bg-red {
  background: red;
}
.bg-teal {
  background: teal;
}

.bg-grey {
  background: grey;
}

.bg-purple {
  background: purple;
}
.full-width {
  left: 0;
  width: calc(100% - 2px);
}
.left-side {
  left: 0;
  width: calc(50% - 3px);
}
.right-side {
  left: 50%;
  width: calc(50% - 3px);
}
.rounded-border {
  border-radius: 2px;
}
</style>
